version: '3.8'
services:
mongodb:
image: mongo:7.0
container_name: loadtest-mongodb
restart: always
environment:
MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
volumes:
- mongodb_data:/data/db
- ./backups:/backups
ports:
- "27017:27017"
networks:
- loadtest-network
logging:
driver: "json-file"
options:
max-size: "10m"
max-file: "3"
redis:
image: redis:7-alpine
container_name: loadtest-redis
restart: always
command: redis-server --requirepass ${REDIS_PASSWORD} --appendonly yes
volumes:
- redis_data:/data
ports:
- "6379:6379"
networks:
- loadtest-network
logging:
driver: "json-file"
options:
max-size: "10m"
max-file: "3"
controller:
image: your-registry/loadtest-controller:${VERSION}
container_name: loadtest-controller
restart: always
environment:
SPRING_PROFILES_ACTIVE: production
MONGODB_URI: ${MONGODB_URI}
REDIS_HOST: redis
REDIS_PASSWORD: ${REDIS_PASSWORD}
SUPABASE_JWT_SECRET: ${SUPABASE_JWT_SECRET}
depends_on:
- mongodb
- redis
ports:
- "8080:8080"
networks:
- loadtest-network
logging:
driver: "json-file"
options:
max-size: "10m"
max-file: "3"
healthcheck:
test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
interval: 30s
timeout: 10s
retries: 3
start_period: 40s
worker:
image: your-registry/loadtest-worker:${VERSION}
restart: always
environment:
REDIS_URL: redis://redis:6379
REDIS_PASSWORD: ${REDIS_PASSWORD}
RUST_LOG: info
MAX_CONCURRENT_REQUESTS: 1000
depends_on:
- redis
- controller
networks:
- loadtest-network
deploy:
replicas: 5
resources:
limits:
cpus: '1'
memory: 512M
reservations:
cpus: '0.5'
memory: 256M
logging:
driver: "json-file"
options:
max-size: "10m"
max-file: "3"
frontend:
image: your-registry/loadtest-frontend:${VERSION}
container_name: loadtest-frontend
restart: always
depends_on:
- controller
ports:
- "80:80"
- "443:443"
networks:
- loadtest-network
volumes:
- ./nginx/ssl:/etc/nginx/ssl:ro
logging:
driver: "json-file"
options:
max-size: "10m"
max-file: "3"
prometheus:
image: prom/prometheus:latest
container_name: loadtest-prometheus
restart: always
volumes:
- ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
- prometheus_data:/prometheus
command:
- '--config.file=/etc/prometheus/prometheus.yml'
- '--storage.tsdb.path=/prometheus'
- '--storage.tsdb.retention.time=15d'
ports:
- "9090:9090"
networks:
- loadtest-network
grafana:
image: grafana/grafana:latest
container_name: loadtest-grafana
restart: always
environment:
GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD}
GF_INSTALL_PLUGINS: grafana-piechart-panel
volumes:
- grafana_data:/var/lib/grafana
- ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards
- ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources
ports:
- "3001:3000"
networks:
- loadtest-network
depends_on:
- prometheus
volumes:
mongodb_data:
driver: local
redis_data:
driver: local
prometheus_data:
driver: local
grafana_data:
driver: local
networks:
loadtest-network:
driver: bridge